<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK252 Data Search</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-title {
            flex: 1;
            min-width: 250px;
        }

        h1 {
            color: #1f77b4;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: #e0e0e0;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.3s;
            flex: 1;
            min-width: 100px;
        }

        .tab:hover {
            background: #d0d0d0;
        }

        .tab.active {
            background: #1f77b4;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-width: 200px;
        }

        .search-input:focus {
            outline: none;
            border-color: #1f77b4;
        }

        .limit-select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-width: 120px;
        }

        .search-btn {
            padding: 12px 24px;
            background: #1f77b4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .search-btn:hover {
            background: #1565a0;
        }

        .message {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .results {
            margin-top: 20px;
        }

        .result-item {
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .result-header {
            padding: 15px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .result-header:hover {
            background: #e9ecef;
        }

        .result-header:active {
            background: #dee2e6;
        }

        .result-header::after {
            content: '‚ñº';
            transition: transform 0.3s;
            font-size: 12px;
            color: #666;
        }

        .result-item.expanded .result-header::after {
            transform: rotate(180deg);
        }

        .result-details {
            display: none;
            padding: 20px;
            background: white;
        }

        .result-item.expanded .result-details {
            display: block;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .detail-table th,
        .detail-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .detail-table th {
            background: #f8f9fa;
            font-weight: 600;
            width: 200px;
        }

        .download-btn {
            margin-top: 20px;
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .download-btn:hover {
            background: #218838;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 280px;
            max-width: 400px;
        }

        .sidebar h2 {
            color: #1f77b4;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .sidebar h3 {
            color: #333;
            margin-top: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .sidebar p {
            font-size: 13px;
            margin-bottom: 8px;
        }

        .sidebar hr {
            margin: 10px 0;
            border: none;
            border-top: 1px solid #ddd;
        }

        .sidebar ul {
            font-size: 13px;
            line-height: 1.6;
            padding-left: 20px;
        }

        .sidebar code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Responsive Design */
        .tab-header-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-title-section {
            flex: 1;
            min-width: 300px;
        }

        .tab-dataset-info {
            flex: 1;
            min-width: 280px;
            max-width: 400px;
        }

        @media (max-width: 992px) {
            .header-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-width: 100%;
                margin-top: 15px;
            }

            .tab-header-section {
                flex-direction: column;
            }

            .tab-dataset-info {
                width: 100%;
                max-width: 100%;
            }

            .search-container {
                flex-wrap: wrap;
            }

            .search-input {
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 15px;
            }

            .header-content {
                flex-direction: column;
            }

            .header-title {
                width: 100%;
            }

            .sidebar {
                width: 100%;
                max-width: 100%;
                margin-top: 15px;
                padding: 12px;
            }

            .tabs {
                flex-wrap: wrap;
                gap: 5px;
                padding: 8px;
            }

            .tab {
                flex: 1;
                min-width: 100px;
                padding: 8px 12px;
                font-size: 14px;
            }

            .search-container {
                flex-direction: column;
                gap: 10px;
            }

            .search-input,
            .limit-select,
            .search-btn {
                width: 100%;
            }

            .tab-content {
                padding: 15px;
            }

            .result-header {
                padding: 12px;
                font-size: 14px;
            }

            .result-details {
                padding: 15px;
            }

            .detail-table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
            }

            .detail-table th,
            .detail-table td {
                padding: 8px;
            }

            .detail-table th {
                width: 120px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 22px;
            }

            .header-title p {
                font-size: 14px;
            }

            .sidebar {
                padding: 10px;
            }

            .sidebar h2 {
                font-size: 16px;
            }

            .sidebar h3 {
                font-size: 13px;
            }

            .sidebar p {
                font-size: 12px;
            }

            .sidebar ul {
                font-size: 12px;
            }

            .result-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                padding: 12px;
            }

            .result-header span {
                font-size: 13px;
                word-break: break-word;
            }

            .detail-table {
                font-size: 11px;
            }

            .detail-table th,
            .detail-table td {
                padding: 6px;
                word-break: break-word;
            }

            .detail-table th {
                width: 100px;
                font-size: 11px;
            }

            .message {
                font-size: 14px;
                padding: 10px;
            }

            .download-btn {
                width: 100%;
                padding: 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <h1>üîç HK252 Data Search</h1>
                    <p>Search across courses, slots, and user-course data</p>
                    <hr>
                    <div>
                        <h3>üí° Search Tips</h3>
                        <div style="padding-left: 25px;">
                            <ul style="line-height: 1.8; margin-top: 10px;">
                                <li>Search is <strong>case-insensitive</strong></li>
                                <li>Searches across <strong>all columns</strong></li>
                                <li>Use partial matches (e.g., "co3015" or "b√πi")</li>
                                <li><strong>Multiple terms</strong>: Use "and" or "&" to search for multiple terms
                                    <ul style="margin-left: 20px; margin-top: 5px;">
                                        <li>Example: <code>co3015 and b√πi</code></li>
                                        <li>Example: <code>software & testing</code></li>
                                    </ul>
                                </li>
                                <li>Results are expandable - click to see full details</li>
                                <li>Each tab has <strong>independent search</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="course">üìö Course</button>
            <button class="tab" data-tab="slot">üìÖ Slot</button>
            <button class="tab" data-tab="user-course">üë• User Course</button>
        </div>

        <!-- Course Tab -->
        <div id="course-tab" class="tab-content active">
            <div class="tab-header-section">
                <div class="tab-title-section">
                    <h2>üìö Course Search</h2>
                    <p>Search courses across all columns</p>
                </div>
                <div class="sidebar tab-dataset-info">
                    <h2>üìä Dataset Info</h2>
                    <div id="course-dataset-info">
                        <div class="loading">Loading dataset info...</div>
                    </div>
                </div>
            </div>
            <div class="search-container">
                <input type="text" id="course-search" class="search-input" placeholder="Enter keywords (use 'and' or '&' for multiple terms)...">
                <select id="course-limit" class="limit-select">
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200" selected>200</option>
                    <option value="all">All</option>
                </select>
                <button class="search-btn" onclick="searchCourse()">üîç Search</button>
            </div>
            <div id="course-results"></div>
        </div>

        <!-- Slot Tab -->
        <div id="slot-tab" class="tab-content">
            <div class="tab-header-section">
                <div class="tab-title-section">
                    <h2>üìÖ Slot Search</h2>
                    <p>Search course slots across all columns</p>
                </div>
                <div class="sidebar tab-dataset-info">
                    <h2>üìä Dataset Info</h2>
                    <div id="slot-dataset-info">
                        <div class="loading">Loading dataset info...</div>
                    </div>
                </div>
            </div>
            <div class="search-container">
                <input type="text" id="slot-search" class="search-input" placeholder="Enter keywords (use 'and' or '&' for multiple terms)...">
                <select id="slot-limit" class="limit-select">
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200" selected>200</option>
                    <option value="all">All</option>
                </select>
                <button class="search-btn" onclick="searchSlot()">üîç Search</button>
            </div>
            <div id="slot-results"></div>
        </div>

        <!-- User Course Tab -->
        <div id="user-course-tab" class="tab-content">
            <div class="tab-header-section">
                <div class="tab-title-section">
                    <h2>üë• User Course Search</h2>
                    <p>Search user-course relationships across all columns</p>
                </div>
                <div class="sidebar tab-dataset-info">
                    <h2>üìä Dataset Info</h2>
                    <div id="user-dataset-info">
                        <div class="loading">Loading dataset info...</div>
                    </div>
                </div>
            </div>
            <div class="search-container">
                <input type="text" id="user-search" class="search-input" placeholder="Enter keywords (use 'and' or '&' for multiple terms)...">
                <select id="user-limit" class="limit-select">
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200" selected>200</option>
                    <option value="all">All</option>
                </select>
                <button class="search-btn" onclick="searchUserCourse()">üîç Search</button>
            </div>
            <div id="user-results"></div>
        </div>
    </div>

    <script>
        // Global data storage
        let coursesData = null;
        let slotData = null;
        let userCourseData = null;
        let datasetInfo = null;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                // Display dataset info for the active tab if available
                if (datasetInfo) {
                    displayDatasetInfoForAllTabs();
                }
            });
        });

        // Load dataset info
        async function loadDatasetInfo() {
            try {
                const response = await fetch('dataset_info.csv');
                const text = await response.text();
                Papa.parse(text, {
                    header: true,
                    complete: (results) => {
                        datasetInfo = {};
                        results.data.forEach(row => {
                            if (row.dataset_name) {
                                datasetInfo[row.dataset_name] = {
                                    total_records: parseInt(row.total_records),
                                    columns: row.columns.split(', ')
                                };
                            }
                        });
                        displayDatasetInfoForAllTabs();
                    }
                });
            } catch (error) {
                console.error('Error loading dataset info:', error);
                document.getElementById('course-dataset-info').innerHTML = '<p>Error loading dataset info</p>';
                document.getElementById('slot-dataset-info').innerHTML = '<p>Error loading dataset info</p>';
                document.getElementById('user-dataset-info').innerHTML = '<p>Error loading dataset info</p>';
            }
        }

        function displayDatasetInfoForAllTabs() {
            if (!datasetInfo) return;
            
            // Course tab info
            if (datasetInfo['Course']) {
                const courseInfo = `
                    <p><strong>Total Records:</strong> ${datasetInfo['Course'].total_records.toLocaleString()}</p>
                    <p><strong>Columns:</strong> ${datasetInfo['Course'].columns.join(', ')}</p>
                `;
                document.getElementById('course-dataset-info').innerHTML = courseInfo;
            }
            
            // Slot tab info
            if (datasetInfo['Slot']) {
                const slotInfo = `
                    <p><strong>Total Records:</strong> ${datasetInfo['Slot'].total_records.toLocaleString()}</p>
                    <p><strong>Columns:</strong> ${datasetInfo['Slot'].columns.join(', ')}</p>
                `;
                document.getElementById('slot-dataset-info').innerHTML = slotInfo;
            }
            
            // User Course tab info
            if (datasetInfo['User Course']) {
                const userInfo = `
                    <p><strong>Total Records:</strong> ${datasetInfo['User Course'].total_records.toLocaleString()}</p>
                    <p><strong>Columns:</strong> ${datasetInfo['User Course'].columns.join(', ')}</p>
                `;
                document.getElementById('user-dataset-info').innerHTML = userInfo;
            }
        }

        // Load CSV data
        async function loadCSV(filename) {
            try {
                const response = await fetch(filename);
                const text = await response.text();
                return new Promise((resolve, reject) => {
                    Papa.parse(text, {
                        header: true,
                        complete: (results) => resolve(results.data),
                        error: (error) => reject(error)
                    });
                });
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                throw error;
            }
        }

        // Search function with AND logic
        function performSearch(data, query, maxResults) {
            if (!query || !data || data.length === 0) return { results: [], total: 0 };

            // Parse multiple search terms
            const queryLower = query.toLowerCase();
            const terms = queryLower.replace(/&/g, 'and').split('and')
                .map(term => term.trim())
                .filter(term => term.length > 0);

            if (terms.length === 0) return { results: [], total: 0 };

            // Filter data - all terms must be found (AND logic)
            const results = data.filter(row => {
                // Check if all terms exist in the row
                return terms.every(term => {
                    // Check if term exists in any column
                    return Object.values(row).some(value => {
                        return String(value).toLowerCase().includes(term);
                    });
                });
            });

            const total = results.length;
            const limitedResults = maxResults === 'all' ? results : results.slice(0, parseInt(maxResults));

            return { results: limitedResults, total };
        }

        // Display results
        function displayResults(results, total, displayed, query, datasetName, columns, containerId) {
            const container = document.getElementById(containerId);
            
            if (displayed === 0) {
                container.innerHTML = `
                    <div class="message warning">
                        No results found for '${query}'. Found ${total} total match(es).
                    </div>
                `;
                return;
            }

            let html = `
                <div class="message success">
                    Found ${total} match(es). Showing ${displayed} result(s).
                </div>
                <div class="results">
            `;

            results.forEach((row, index) => {
                // Create title based on dataset
                let title = '';
                if (datasetName === 'Course') {
                    const name = String(row.name || '').substring(0, 80);
                    title = `üìö ${row.course_code || ''} - ${name}${String(row.name || '').length > 80 ? '...' : ''}`;
                } else if (datasetName === 'Slot') {
                    const name = String(row.name || '').substring(0, 80);
                    title = `üìÖ ${row.code || ''} - ${name}${String(row.name || '').length > 80 ? '...' : ''}`;
                } else {
                    const userName = String(row.user_name || '').substring(0, 60);
                    title = `üë• ${row.course_code || ''} - ${userName}${String(row.user_name || '').length > 60 ? '...' : ''}`;
                }

                html += `
                    <div class="result-item" id="result-${datasetName}-${index}">
                        <div class="result-header" onclick="toggleResult('result-${datasetName}-${index}')">
                            <span>${title}</span>
                        </div>
                        <div class="result-details">
                            <table class="detail-table">
                                ${columns.map(col => `
                                    <tr>
                                        <th>${col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>
                                        <td>${row[col] || ''}</td>
                                    </tr>
                                `).join('')}
                            </table>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Add download button
            html += `
                <button class="download-btn" onclick="downloadResults('${datasetName}', '${query.replace(/'/g, "\\'")}')">
                    üì• Download Results as CSV
                </button>
            `;

            container.innerHTML = html;

            // Store results for download
            window[`${datasetName.toLowerCase().replace(' ', '_')}_current_results`] = results;
            window[`${datasetName.toLowerCase().replace(' ', '_')}_current_query`] = query;
        }

        function toggleResult(id) {
            const item = document.getElementById(id);
            item.classList.toggle('expanded');
        }

        // Search functions for each tab
        async function searchCourse() {
            const query = document.getElementById('course-search').value;
            const limit = document.getElementById('course-limit').value;
            
            if (!query) {
                document.getElementById('course-results').innerHTML = 
                    '<div class="message info">Please enter a search query.</div>';
                return;
            }

            if (!coursesData) {
                document.getElementById('course-results').innerHTML = 
                    '<div class="loading">Loading course data...</div>';
                coursesData = await loadCSV('courses_hk252.csv');
            }

            const { results, total } = performSearch(coursesData, query, limit);
            const columns = Object.keys(coursesData[0] || {});
            displayResults(results, total, results.length, query, 'Course', columns, 'course-results');
        }

        async function searchSlot() {
            const query = document.getElementById('slot-search').value;
            const limit = document.getElementById('slot-limit').value;
            
            if (!query) {
                document.getElementById('slot-results').innerHTML = 
                    '<div class="message info">Please enter a search query.</div>';
                return;
            }

            if (!slotData) {
                document.getElementById('slot-results').innerHTML = 
                    '<div class="loading">Loading slot data...</div>';
                slotData = await loadCSV('slot_hk252.csv');
            }

            const { results, total } = performSearch(slotData, query, limit);
            const columns = Object.keys(slotData[0] || {});
            displayResults(results, total, results.length, query, 'Slot', columns, 'slot-results');
        }

        async function searchUserCourse() {
            const query = document.getElementById('user-search').value;
            const limit = document.getElementById('user-limit').value;
            
            if (!query) {
                document.getElementById('user-results').innerHTML = 
                    '<div class="message info">Please enter a search query.</div>';
                return;
            }

            if (!userCourseData) {
                document.getElementById('user-results').innerHTML = 
                    '<div class="loading">Loading user course data...</div>';
                userCourseData = await loadCSV('user_course_hk252.csv');
            }

            const { results, total } = performSearch(userCourseData, query, limit);
            const columns = Object.keys(userCourseData[0] || {});
            displayResults(results, total, results.length, query, 'User Course', columns, 'user-results');
        }

        // Download results as CSV
        function downloadResults(datasetName, query) {
            const varName = datasetName.toLowerCase().replace(' ', '_');
            const results = window[`${varName}_current_results`];
            
            if (!results || results.length === 0) return;

            // Convert to CSV
            const headers = Object.keys(results[0]);
            const csv = [
                headers.join(','),
                ...results.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        // Escape quotes and wrap in quotes if contains comma or quote
                        if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                            return `"${String(value).replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${varName}_search_results_${query.replace(/ /g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Enter key support
        document.getElementById('course-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchCourse();
        });
        document.getElementById('slot-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchSlot();
        });
        document.getElementById('user-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchUserCourse();
        });

        // Load dataset info on page load
        loadDatasetInfo();
    </script>
</body>
</html>
